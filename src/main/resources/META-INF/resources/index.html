<!DOCTYPE html>
<html>
<!--
  WARNING! Make sure that you match all Quasar related
  tags to the same version! (Below it's "@1.14.1")
-->

<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons|Material+Icons+Outlined|Material+Icons+Round|Material+Icons+Sharp"
          rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@^5.0.0/css/materialdesignicons.min.css" rel="stylesheet"
          type="text/css">
    <link href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/ionicons@^4.0.0/dist/css/ionicons.min.css" rel="stylesheet"
          type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/eva-icons@^1.0.0/style/eva-icons.css" rel="stylesheet" type="text/css">
    <link href="https://themify.me/wp-content/themes/themify-v32/themify-icons/themify-icons.css" rel="stylesheet"
          type="text/css">
    <link href="https://maxst.icons8.com/vue-static/landings/line-awesome/font-awesome-line-awesome/css/all.min.css"
          rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/animate.css@^4.0.0/animate.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@1.14.1/dist/quasar.min.css" rel="stylesheet" type="text/css">
</head>

<body>

<div id="q-app">


    <div class="flex flex-center column">
        <div class="row" style="min-height: 400px; width: 100%;">
            <q-layout>

                <div class="fit row wrap justify-start items-start content-start" id="parent" style="overflow: hidden;">

                    <div class="q-pa-md row items-start q-gutter-md" style="overflow: auto;" v-for="postit in postits">
                        <q-card class="my-card shadow-1 bg-yellow-2 q-pa-xs" square style="min-width:150px">
                            <q-card-section class="q-ma-none q-pa-xs">
                                <pre style="margin:0;padding:0" v-html="postit.text"></pre>
                            </q-card-section>
                            <q-card-actions align="right">
                                <q-btn @click="confirmDelete(postit.id)" color="red" flat icon="delete" round size="xs"
                                       v-show="postit.user==user"></q-btn>
                                <q-btn @click="editPostit(postit.id)" color="gray" flat icon="edit" round size="xs"
                                       v-show="postit.user==user"></q-btn>
                            </q-card-actions>
                        </q-card>
                    </div>

                    <q-page-sticky :offset="[18, 18]" position="bottom-right">
                        <q-btn @click="addDialog = true" color="accent" fab icon="add"></q-btn>
                    </q-page-sticky>

                </div>
            </q-layout>


        </div>
    </div>

    <q-dialog persistent v-model="deleteDialog">
        <q-card>
            <q-card-section class="row items-center">
                Confirmer la suppression ?
            </q-card-section>

            <q-card-actions align="right">
                <q-btn color="primary" flat label="Non" v-close-popup></q-btn>
                <q-btn @click="deletePostit()" autofocus color="primary" label="Oui" v-close-popup></q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

    <q-dialog full-width persistent v-model="addDialog">
        <q-card>
            <q-card-section class="row items-center">
                <div class="q-pa-md" style="width: 100%">
                    <q-input
                            autofocus
                            label="Texte du PostIt"
                            outlined
                            type="textarea" v-model="textNew"
                    />
                </div>
            </q-card-section>

            <q-card-actions align="right">
                <q-btn color="primary" flat label="Annuler" v-close-popup></q-btn>
                <q-btn @click="addPostit()" color="primary" label="Ajouter" v-close-popup></q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

    <q-dialog full-width persistent v-model="editDialog">
        <q-card>
            <q-card-section class="row items-center">
                <div class="q-pa-md" style="width: 100%">
                    <q-input
                            autofocus
                            label="Texte du PostIt"
                            outlined
                            type="textarea"
                            v-model="textEdit"
                    />
                </div>
            </q-card-section>

            <q-card-actions align="right">
                <q-btn color="primary" flat label="Annuler" v-close-popup></q-btn>
                <q-btn @click="doEditPostit()" color="primary" label="Modifier" v-close-popup></q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

    <q-dialog full-width persistent v-model="userDialog">
        <q-card>
            <q-card-section class="row items-center">
                <div class="q-pa-md" style="width: 100%">
                    <q-input @keydown.enter.prevent="connect()"
                             autofocus label="Nom d'utilisateur"
                             v-model="user"
                    >
                        <template v-slot:prepend>
                            <q-icon name="fas fa-user"/>
                        </template>


                    </q-input>
                </div>
            </q-card-section>

            <q-card-actions align="right">
                <q-btn @click="connect()" color="primary" label="Ok" v-close-popup></q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

</div>

<!-- Add the following at the end of your body tag -->

<script src="https://cdn.jsdelivr.net/npm/vue@^2.0.0/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quasar@1.14.1/dist/quasar.umd.modern.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quasar@1.14.1/dist/lang/fr.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
      Quasar.lang.set(Quasar.lang.fr)

      new Vue({
        el: '#q-app',
        data: function () {
          return {
            connection: null,
            addDialog: false,
            deleteDialog: false,
            deletingId: -1,
            userDialog: true,
            editDialog: false,
            editingId: -1,
            textNew: '',
            textEdit: '',
            user: '',
            postits: null
          }
        },
        methods: {

            confirmDelete: function(id){
                this.deleteDialog = true
                this.deletingId = id
            },

            deletePostit: function(){
            me = this;
                axios({
                  method: 'delete',
                  url: '/api/postit/'+this.deletingId,
                  }).then(function () {
                    me.deletingId = -1
                    me.refresh()
                    me.connection.send('refresh');
                    })
            },

            editPostit: function(id){
            this.editingId = id
            me = this
                axios({
                  method: 'get',
                  url: '/api/postit/'+me.editingId
                  }).then(function (response) {
                    me.textEdit = response.data.text
                    me.editDialog = true
                    })
            },

            doEditPostit: function(){
             me = this;
                axios({
                  method: 'post',
                  url: '/api/postit/'+this.editingId,
                  data: {
                    text: this.textEdit,
                    user: this.user
                  }
                }).then(function () {
                    me.textEdit = '';
                    me.editingId = -1
                   me.refresh();
                   me.connection.send('refresh');
                   });
            },

            addPostit: function(){
             me = this;
                axios({
                  method: 'post',
                  url: '/api/postit',
                  data: {
                    text: this.textNew,
                    user: this.user
                  }
                }).then(function () {
                    me.textNew = '';
                   me.refresh();
                   me.connection.send('refresh');
                   });
            },

            refresh: function(){
                axios
                  .get('/api/postit')
                  .then(response => (this.postits = response.data));

            },

            connect: function() {
                this.userDialog = false
                console.log("Starting connection to WebSocket Server")
                this.connection = new WebSocket("ws://"+location.host+"/websock/"+this.user)

                me = this
                this.connection.onmessage = function(event) {
                  console.log(event);
                  if(event.data.includes('refresh')){
                    me.refresh();
                  }
                }

                this.connection.onopen = function(event) {
                  console.log(event)
                  console.log("Successfully connected to the websocket server...")
                }

              }

        },
        mounted () {
            this.refresh();
        }
      })

</script>
</body>
</html>
